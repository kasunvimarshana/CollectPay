# PayTrack Deployment Guide

## Overview

This guide covers deploying PayTrack backend (Laravel API) and frontend (React Native mobile app) to production.

## Prerequisites

- PHP 8.1+ with required extensions
- MySQL 5.7+ or MariaDB 10.3+
- Composer
- Node.js 18+ (LTS)
- Web server (Apache/Nginx)
- SSL certificate
- Domain name

## Backend Deployment

### 1. Server Setup

#### Ubuntu/Debian
```bash
# Update system
sudo apt update && sudo apt upgrade -y

# Install PHP and extensions
sudo apt install -y php8.1 php8.1-fpm php8.1-mysql php8.1-xml php8.1-curl php8.1-mbstring php8.1-zip php8.1-bcmath

# Install MySQL
sudo apt install -y mysql-server

# Install Composer
curl -sS https://getcomposer.org/installer | php
sudo mv composer.phar /usr/local/bin/composer

# Install Nginx
sudo apt install -y nginx
```

### 2. Database Setup

```bash
# Login to MySQL
sudo mysql

# Create database and user
CREATE DATABASE paytrack;
CREATE USER 'paytrack_user'@'localhost' IDENTIFIED BY 'strong_password_here';
GRANT ALL PRIVILEGES ON paytrack.* TO 'paytrack_user'@'localhost';
FLUSH PRIVILEGES;
EXIT;
```

### 3. Application Deployment

```bash
# Clone repository
cd /var/www
sudo git clone https://github.com/kasunvimarshana/PayTrack.git
cd PayTrack/backend

# Install dependencies
composer install --optimize-autoloader --no-dev

# Set permissions
sudo chown -R www-data:www-data /var/www/PayTrack
sudo chmod -R 755 /var/www/PayTrack
sudo chmod -R 775 storage bootstrap/cache

# Configure environment
cp .env.example .env
php artisan key:generate

# Edit .env file
nano .env
```

### 4. Environment Configuration

Edit `.env`:
```env
APP_NAME=PayTrack
APP_ENV=production
APP_KEY=base64:... # Generated by key:generate
APP_DEBUG=false
APP_URL=https://api.yourdomain.com

DB_CONNECTION=mysql
DB_HOST=127.0.0.1
DB_PORT=3306
DB_DATABASE=paytrack
DB_USERNAME=paytrack_user
DB_PASSWORD=strong_password_here

# Security
SANCTUM_STATEFUL_DOMAINS=yourdomain.com
SESSION_DOMAIN=.yourdomain.com

# API Configuration
API_VERSION=v1
API_RATE_LIMIT=60

# Sync Configuration
SYNC_BATCH_SIZE=100
SYNC_CONFLICT_STRATEGY=server_wins
```

### 5. Run Migrations

```bash
php artisan migrate --force
```

### 6. Nginx Configuration

Create `/etc/nginx/sites-available/paytrack`:
```nginx
server {
    listen 80;
    listen [::]:80;
    server_name api.yourdomain.com;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name api.yourdomain.com;
    root /var/www/PayTrack/backend/public;

    # SSL Configuration
    ssl_certificate /etc/letsencrypt/live/api.yourdomain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/api.yourdomain.com/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    # Security Headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

    # Logging
    access_log /var/log/nginx/paytrack-access.log;
    error_log /var/log/nginx/paytrack-error.log;

    index index.php index.html;
    charset utf-8;

    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    location ~ \.php$ {
        include snippets/fastcgi-php.conf;
        fastcgi_pass unix:/var/run/php/php8.1-fpm.sock;
        fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
        include fastcgi_params;
    }

    location ~ /\.(?!well-known).* {
        deny all;
    }

    # Rate limiting
    limit_req_zone $binary_remote_addr zone=api:10m rate=60r/m;
    limit_req zone=api burst=10 nodelay;
}
```

Enable site:
```bash
sudo ln -s /etc/nginx/sites-available/paytrack /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

### 7. SSL Certificate (Let's Encrypt)

```bash
sudo apt install -y certbot python3-certbot-nginx
sudo certbot --nginx -d api.yourdomain.com
```

### 8. Optimize Laravel

```bash
# Cache configuration
php artisan config:cache

# Cache routes
php artisan route:cache

# Cache views
php artisan view:cache

# Optimize autoloader
composer dump-autoload --optimize
```

### 9. Setup Supervisor (Queue Workers)

Create `/etc/supervisor/conf.d/paytrack-worker.conf`:
```ini
[program:paytrack-worker]
process_name=%(program_name)s_%(process_num)02d
command=php /var/www/PayTrack/backend/artisan queue:work --sleep=3 --tries=3 --max-time=3600
autostart=true
autorestart=true
stopasgroup=true
killasgroup=true
user=www-data
numprocs=2
redirect_stderr=true
stdout_logfile=/var/www/PayTrack/backend/storage/logs/worker.log
stopwaitsecs=3600
```

Start worker:
```bash
sudo supervisorctl reread
sudo supervisorctl update
sudo supervisorctl start paytrack-worker:*
```

### 10. Setup Cron Jobs

```bash
sudo crontab -e
```

Add:
```cron
* * * * * cd /var/www/PayTrack/backend && php artisan schedule:run >> /dev/null 2>&1
```

### 11. Backup Strategy

Create backup script `/usr/local/bin/backup-paytrack.sh`:
```bash
#!/bin/bash

BACKUP_DIR="/backups/paytrack"
DATE=$(date +%Y%m%d_%H%M%S)

# Create backup directory
mkdir -p $BACKUP_DIR

# Backup database
mysqldump -u paytrack_user -p'password' paytrack | gzip > $BACKUP_DIR/db_$DATE.sql.gz

# Backup files
tar -czf $BACKUP_DIR/files_$DATE.tar.gz /var/www/PayTrack/backend/storage

# Keep only last 7 days
find $BACKUP_DIR -mtime +7 -delete

echo "Backup completed: $DATE"
```

Make executable and add to cron:
```bash
sudo chmod +x /usr/local/bin/backup-paytrack.sh
sudo crontab -e
# Add: 0 2 * * * /usr/local/bin/backup-paytrack.sh
```

## Frontend Deployment

### 1. Update Configuration

Edit `frontend/.env`:
```env
EXPO_PUBLIC_API_URL=https://api.yourdomain.com/api/v1
```

### 2. Build for Android

```bash
cd frontend

# Install dependencies
npm install

# Build APK
npx expo build:android -t apk

# Or build AAB for Play Store
npx expo build:android -t app-bundle
```

### 3. Build for iOS

```bash
# Build for App Store
npx expo build:ios -t archive

# Or build for simulator
npx expo build:ios -t simulator
```

### 4. Using EAS Build (Recommended)

```bash
# Install EAS CLI
npm install -g eas-cli

# Login
eas login

# Configure
eas build:configure

# Build
eas build --platform android
eas build --platform ios
```

### 5. Over-The-Air Updates

Configure `app.json`:
```json
{
  "expo": {
    "updates": {
      "url": "https://u.expo.dev/your-project-id"
    },
    "runtimeVersion": {
      "policy": "sdkVersion"
    }
  }
}
```

Publish update:
```bash
eas update --branch production --message "Bug fixes"
```

## Monitoring & Maintenance

### 1. Application Monitoring

Install Laravel Telescope (development only):
```bash
composer require laravel/telescope --dev
php artisan telescope:install
php artisan migrate
```

### 2. Error Tracking

Consider using:
- Sentry
- Bugsnag
- Rollbar

### 3. Performance Monitoring

- New Relic
- Datadog
- AppSignal

### 4. Log Management

```bash
# View logs
tail -f /var/www/PayTrack/backend/storage/logs/laravel.log

# Rotate logs
sudo apt install logrotate
```

Create `/etc/logrotate.d/paytrack`:
```
/var/www/PayTrack/backend/storage/logs/*.log {
    daily
    missingok
    rotate 14
    compress
    delaycompress
    notifempty
    create 0644 www-data www-data
    sharedscripts
}
```

### 5. Health Checks

Setup monitoring for:
- API health endpoint: `GET /api/health`
- Database connectivity
- Disk space
- Memory usage
- CPU usage

### 6. Security Updates

```bash
# Regular updates
sudo apt update && sudo apt upgrade -y

# Update Composer dependencies
composer update --with-dependencies

# Update npm packages
npm update
```

## Scaling Considerations

### Horizontal Scaling

1. **Load Balancer**: Nginx/HAProxy
2. **Database**: Read replicas
3. **Cache**: Redis/Memcached
4. **Sessions**: Redis/Database
5. **Queue**: Redis/SQS

### Vertical Scaling

- Increase server resources
- Optimize database queries
- Enable OPcache
- Use CDN for static assets

## Troubleshooting

### Common Issues

**Permission Errors**
```bash
sudo chown -R www-data:www-data /var/www/PayTrack
sudo chmod -R 755 /var/www/PayTrack
sudo chmod -R 775 storage bootstrap/cache
```

**Database Connection Failed**
```bash
# Check MySQL status
sudo systemctl status mysql

# Check credentials in .env
# Verify firewall rules
```

**502 Bad Gateway**
```bash
# Check PHP-FPM
sudo systemctl status php8.1-fpm

# Check Nginx logs
sudo tail -f /var/log/nginx/error.log
```

**Queue Not Processing**
```bash
# Restart workers
sudo supervisorctl restart paytrack-worker:*

# Check worker logs
tail -f storage/logs/worker.log
```

## Production Checklist

Backend:
- [ ] Environment set to production
- [ ] Debug mode disabled
- [ ] Strong database password
- [ ] SSL certificate installed
- [ ] Firewall configured
- [ ] Logs rotation setup
- [ ] Backups automated
- [ ] Queue workers running
- [ ] Cron jobs scheduled
- [ ] Error tracking enabled

Frontend:
- [ ] API URL configured
- [ ] App signed for stores
- [ ] Analytics integrated
- [ ] Crash reporting enabled
- [ ] OTA updates configured
- [ ] App store listing complete

## Support

For deployment assistance:
- Documentation: https://docs.paytrack.com
- Email: support@paytrack.com
- Community: https://community.paytrack.com
